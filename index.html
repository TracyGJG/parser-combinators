<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JSON parser</title>
  </head>
  <body>
    <script type="module">
      import {
        parseArray,
        parseNumber,
        parseString,
        parseWhitespace,
      } from './parsers.js';

      // Array
      {
        const testCase = testParser(parseArray, false);
        testCase(
          {
            data: `[`,
            index: 0,
            error: '',
          },
          1,
          'Error at 1: Unexpected End of Input'
        );
        testCase(
          {
            data: `[0`,
            index: 0,
            error: '',
          },
          1,
          ''
        );
        testCase(
          {
            data: `[]`,
            index: 0,
            error: '',
          },
          1,
          ''
        );
        testCase(
          {
            data: `[   ]`,
            index: 0,
            error: '',
          },
          5,
          ''
        );
      }

      // Number
      {
        const testCase = testParser(parseNumber);
        testCase(
          {
            data: `0`,
            index: 0,
            error: '',
          },
          1,
          ''
        );
        testCase(
          {
            data: `0A`,
            index: 0,
            error: '',
          },
          1,
          ''
        );
        testCase(
          {
            data: `-0`,
            index: 0,
            error: '',
          },
          2,
          ''
        );
        testCase(
          {
            data: `4`,
            index: 0,
            error: '',
          },
          1,
          ''
        );
        testCase(
          {
            data: `42`,
            index: 0,
            error: '',
          },
          2,
          ''
        );
        // Fraction
        testCase(
          {
            data: `0.0`,
            index: 0,
            error: '',
          },
          3,
          ''
        );
        // Exponent
        testCase(
          {
            data: `0E+0`,
            index: 0,
            error: '',
          },
          4,
          ''
        );
        testCase(
          {
            data: `0e-42`,
            index: 0,
            error: '',
          },
          5,
          ''
        );

        testCase();
      }

      // string
      {
        const testCase = testParser(parseString);
        testCase(
          {
            data: `"`,
            index: 0,
            error: '',
          },
          1,
          ''
        );
        testCase({ data: '""', index: 0, error: '' }, 2, '');
        testCase({ data: '"_"', index: 0, error: '' }, 3, '');
        testCase({ data: `\"`, index: 0, error: '' }, 1, '');
        testCase({ data: `" "`, index: 0, error: '' }, 3, '');
        testCase({ data: '"\u2665"', index: 0, error: '' }, 3, '');
        testCase(
          { data: '"\t"', index: 0, error: '' },
          1,
          'Error at 1: Invalid character encountered'
        );
        testCase(
          { data: '"\\"', index: 0, error: '' },
          3,
          'Error at 3: Unexpected end of input'
        );
        testCase();
      }

      // whitespace
      {
        const testCase = testParser(parseWhitespace);
        testCase({ data: '', index: 0, error: '' }, 0, '');
        testCase({ data: '_ \n\r\t', index: 0, error: '' }, 0, '');
        testCase({ data: ' \n\r\t_', index: 0, error: '' }, 4, '');
        testCase();
      }

      function testParser(parser, collapsed = true) {
        const consoleMethod = ['group', 'groupCollapsed'][+collapsed];
        console[consoleMethod](parser.name);
        let testCaseNum = 0;
        return (testData, index, error) => {
          if (!testData) {
            console.groupEnd();
            return;
          }
          const result = parser(testData);
          console.log(
            `\t${++testCaseNum}: ${JSON.stringify(result)} (${
              testData.data.length
            })`
          );
          console.log(`\t\tindex: ${index}, error: ${error}`);
          console.assert(result.index === index);
          console.assert(result.error === error);
        };
      }
    </script>
  </body>
</html>
